# Архитектурная Диаграмма Cinema EPG Collector

## Общая Архитектура Системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Cinema EPG Collector                              │
│                           Full-Stack Application                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
          ┌─────────▼─────────┐ ┌────────▼─────────┐ ┌──────▼──────┐
          │   Frontend       │ │   Backend API    │ │  Database    │
          │   (React/Vite)   │ │   (FastAPI)      │ │  (JSON/FS)   │
          └─────────────────┘ └─────────────────┘ └─────────────┘
                    │                   │                   │
                    └───────────────────┼───────────────────┘
                                        │
                    ┌───────────────────▼───────────────────┐
                    │           External Services           │
                    └───────────────────────────────────────┘
                                        │
                    ┌───────────────────▼───────────────────┐
                    │                                       │
          ┌─────────▼─────────┐                   ┌────────▼─────────┐
          │   IPTV Provider   │                   │   TMDB API       │
          │   (EPG Source)    │                   │   (Metadata)     │
          └─────────────────┘                   └─────────────────┘
```

## Детальная Архитектура Компонентов

```
Cinema EPG Collector Architecture
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                             User Interface Layer                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌────────────────────────────────────┐  ┌─────────┐  │
│  │   Web Client    │  │         REST API                   │  │  CLI     │  │
│  │   (React/Vite)  │  │         (FastAPI)                  │  │  Tool    │  │
│  │                 │  │                                    │  │         │  │
│  │  - Movie List   │  │  GET  /api/movies                 │  │ - fetch  │  │
│  │  - Search       │  │  GET  /api/movies/{id}            │  │ - filter │  │
│  │  - Details      │  │  GET  /api/movies/search          │  │ - enrich │  │
│  │  - Posters      │  │  GET  /static/posters/...         │  │ - run-all│  │
│  └─────────────────┘  └────────────────────────────────────┘  └─────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Business Logic Layer                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   IPTV Client   │  │   TMDB Client    │  │  Data Filter    │            │
│  │                 │  │                 │  │                 │            │
│  │  - API calls    │  │  - Movie search │  │  - Category     │            │
│  │  - Data parsing │  │  - Metadata     │  │  - Validation   │            │
│  │  - Error handle │  │  - Poster URLs  │  │  - Cleaning     │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │ Poster Download │  │   HTTP Cache    │  │   File Cache    │            │
│  │                 │  │                 │  │                 │            │
│  │  - Image fetch  │  │  - requests     │  │  - TMDB data    │            │
│  │  - Validation   │  │  - retry logic  │  │  - Local store  │            │
│  │  - Local store  │  │  - expiration   │  │  - Fast lookup  │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────┐
│                             Data Layer                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Raw EPG       │  │   Filtered      │  │   Enriched      │            │
│  │   Data          │  │   Movies        │  │   Movies        │            │
│  │                 │  │                 │  │                 │            │
│  │  data/raw_      │  │  data/movies.   │  │  data/enriched_ │            │
│  │  epg.json       │  │  json           │  │  movies.json    │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Posters       │  │   Cache         │  │   Logs          │            │
│  │   Directory     │  │   Directory     │  │   Directory     │            │
│  │                 │  │                 │  │                 │            │
│  │  data/posters/  │  │  cache/         │  │  logs/          │            │
│  │  *.jpg          │  │  *.sqlite       │  │  app.log        │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Infrastructure Layer                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Docker        │  │   Nginx         │  │   Docker        │            │
│  │   Container     │  │   Reverse       │  │   Compose      │            │
│  │                 │  │   Proxy         │  │                 │            │
│  │  - Python 3.12  │  │  - Load         │  │  - Orchestration│            │
│  │  - FastAPI      │  │    balance      │  │  - Networking   │            │
│  │  - Uvicorn      │  │  - Static cache │  │  - Volumes      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow Diagram

```
Data Processing Pipeline
═══════════════════════════════════════════════════════════════════════════════

1. IPTV API Request
   ┌─────────────────────────────────────────────────────────────────────┐
   │  IPTV Provider → HTTP Client → Raw EPG Data → JSON Storage         │
   └─────────────────────────────────────────────────────────────────────┘

2. Data Filtering
   ┌─────────────────────────────────────────────────────────────────────┐
   │  Raw EPG → Category Filter → Movies Only → JSON Storage            │
   └─────────────────────────────────────────────────────────────────────┘

3. TMDB Enrichment
   ┌─────────────────────────────────────────────────────────────────────┐
   │  Movies → TMDB Search → Metadata → Poster URLs → Enriched Data     │
   └─────────────────────────────────────────────────────────────────────┘

4. Poster Download
   ┌─────────────────────────────────────────────────────────────────────┐
   │  Poster URLs → HTTP Download → Image Validation → Local Storage     │
   └─────────────────────────────────────────────────────────────────────┘

5. API Serving
   ┌─────────────────────────────────────────────────────────────────────┐
   │  Enriched Data → FastAPI → REST API → Frontend → User              │
   └─────────────────────────────────────────────────────────────────────┘
```

## Component Interaction Diagram

```
Component Communication Flow
═══════════════════════════════════════════════════════════════════════════════

┌─────────────┐    HTTP GET     ┌─────────────┐    JSON     ┌─────────────┐
│   IPTV      │ ──────────────► │   Collector │ ──────────► │   Storage   │
│   Provider  │                 │             │             │             │
└─────────────┘                 └─────────────┘             └─────────────┘
         ▲                              │                            │
         │                              │                            │
         │                       ┌──────▼──────┐                     │
         │                       │   Filter    │                     │
         │                       │   Engine    │                     │
         │                       └─────────────┘                     │
         │                              │                            │
         │                       ┌──────▼──────┐                     │
         │                       │   TMDB      │                     │
         │                       │   Client    │                     │
         │                       └─────────────┘                     │
         │                              │                            │
         │                       ┌──────▼──────┐                     │
         │                       │   Poster    │                     │
         │                       │   Download  │                     │
         │                       └─────────────┘                     │
         │                              │                            │
         │                       ┌──────▼──────┐                     │
         │                       │   FastAPI   │                     │
         │                       │   Server    │                     │
         │                       └─────────────┘                     │
         │                              │                            │
         │                       ┌──────▼──────┐                     │
         │                       │   Frontend  │                     │
         │                       │   Client    │                     │
         └──────────────────────► └─────────────┘ ◄───────────────────┘
                                        ▲
                                        │
                                 ┌──────┴──────┐
                                 │   User       │
                                 │   Browser    │
                                 └─────────────┘
```

## Deployment Architecture

```
Production Deployment
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                           Docker Compose Stack                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        Load Balancer (Nginx)                       │    │
│  │                                                                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │    │
│  │  │   Port 80   │  │   Port 443  │  │   /api/*    │  │   /static/* │ │    │
│  │  │   HTTP      │  │   HTTPS     │  │   Proxy     │  │   Cache     │ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                        │
│  ┌──────────────────────────────────┼──────────────────────────────────┐     │
│  │                                                                          │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │ │
│  │  │   API Service   │  │   Background     │  │   File System   │        │ │
│  │  │   (FastAPI)     │  │   Pipeline       │  │   Volumes       │        │ │
│  │  │                 │  │   Container      │  │                 │        │ │
│  │  │  - REST API     │  │  - Data fetch    │  │  - data/        │        │ │
│  │  │  - WebSocket    │  │  - Processing    │  │  - cache/       │        │ │
│  │  │  - CORS         │  │  - Enrichment    │  │  - logs/        │        │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                    ┌───────────────────▼───────────────────┐
                    │           External Dependencies       │
                    └───────────────────────────────────────┘
                                        │
                    ┌───────────────────▼───────────────────┐
                    │                                       │
          ┌─────────▼─────────┐                   ┌────────▼─────────┐
          │   IPTV Provider   │                   │   TMDB API       │
          │   (pl.iptv2021)   │                   │   (themoviedb)   │
          └─────────────────┘                   └─────────────────┘
```

## Security Architecture

```
Security Layers
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                         Security Perimeter                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Network       │  │   Container     │  │   Application   │            │
│  │   Security      │  │   Security      │  │   Security      │            │
│  │                 │  │                 │  │                 │            │
│  │  - Firewall     │  │  - Non-root     │  │  - Input        │            │
│  │  - Rate limit   │  │  - Read-only    │  │    validation   │            │
│  │  - HTTPS        │  │  - Minimal      │  │  - CORS         │            │
│  │  - DDoS         │  │    image        │  │  - Auth tokens  │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Data          │  │   API           │  │   Monitoring    │            │
│  │   Protection    │  │   Security      │  │                 │            │
│  │                 │  │                 │  │                 │            │
│  │  - Encryption   │  │  - Rate limit   │  │  - Logs         │            │
│  │  - Validation   │  │  - Request size │  │  - Health check │            │
│  │  - Sanitization │  │  - Timeout      │  │  - Metrics      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Performance Architecture

```
Performance Optimization Layers
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                      Performance Stack                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Caching       │  │   Compression   │  │   Connection    │            │
│  │   Layer         │  │   Layer         │  │   Pooling       │            │
│  │                 │  │                 │  │                 │            │
│  │  - HTTP cache   │  │  - Gzip         │  │  - Keep-alive   │            │
│  │  - File cache   │  │  - Brotli       │  │  - Connection   │            │
│  │  - Memory cache │  │  - Static       │  │    reuse        │            │
│  │  - CDN          │  │    files        │  │  - Pool size    │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   Database      │  │   Async/        │  │   Background    │            │
│  │   Optimization  │  │   Concurrency   │  │   Processing    │            │
│  │                 │  │                 │  │                 │            │
│  │  - Indexing     │  │  - FastAPI      │  │  - Pipeline     │            │
│  │  - Query opt    │  │  - Async IO     │  │  - Queue        │            │
│  │  - Connection   │  │  - Threading    │  │  - Batch        │            │
│  │    pooling      │  │  - Coroutines   │  │    processing   │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Database Schema (JSON Structure)

```
Data Storage Structure
═══════════════════════════════════════════════════════════════════════════════

Raw EPG Data (data/raw_epg.json)
┌─────────────────────────────────────────────────────────────────────────────┐
│  [                                                                       │
│    {                                                                     │
│      "id": "19100159618",                                               │
│      "title": "Матрица",                                                 │
│      "desc": "Фильм о виртуальной реальности",                          │
│      "cat": "Х/ф",                                                       │
│      "timestart": 1640995200,                                           │
│      "preview": "http://example.com/pic/12345?size=320x240"             │
│    },                                                                    │
│    ...                                                                   │
│  ]                                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

Filtered Movies (data/movies.json)
┌─────────────────────────────────────────────────────────────────────────────┐
│  [                                                                       │
│    {                                                                     │
│      "id": "19100159618",                                               │
│      "title": "Матрица",                                                 │
│      "desc": "Фильм о виртуальной реальности",                          │
│      "preview": "http://example.com/pic/12345?size=320x240"             │
│      "category": "Х/ф"                                                   │
│    }                                                                     │
│  ]                                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

Enriched Movies (data/enriched_movies.json)
┌─────────────────────────────────────────────────────────────────────────────┐
│  [                                                                       │
│    {                                                                     │
│      "id": "19100159618",                                               │
│      "title": "Матрица",                                                 │
│      "desc": "Фильм о виртуальной реальности",                          │
│      "preview": "http://example.com/pic/12345?size=320x240",            │
│      "tmdb_data": {                                                      │
│        "source": "tmdb",                                                 │
│        "name": "The Matrix",                                             │
│        "year": 1999,                                                     │
│        "rating_imdb": 8.7,                                               │
│        "genres": ["Action", "Sci-Fi"],                                   │
│        "poster_url": "https://image.tmdb.org/t/p/w500/poster.jpg"        │
│      },                                                                  │
│      "poster_local": "data/posters/19100159618-matrix.jpg",              │
│      "poster_source": "tmdb"                                             │
│    }                                                                     │
│  ]                                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## API Response Structure

```
REST API Responses
═══════════════════════════════════════════════════════════════════════════════

GET /api/movies Response
┌─────────────────────────────────────────────────────────────────────────────┐
│  {                                                                       │
│    "movies": [                                                           │
│      {                                                                   │
│        "id": "19100159618",                                             │
│        "epg_data": {                                                     │
│          "title": "Матрица",                                             │
│          "description": "Фильм о виртуальной реальности",               │
│          "broadcast_time": "2025-08-13T13:40:00",                       │
│          "preview_image": "http://example.com/pic/12345?size=320x240"   │
│        },                                                                │
│        "tmdb_data": {                                                    │
│          "title": "The Matrix",                                          │
│          "year": 1999,                                                   │
│          "rating": 8.7,                                                  │
│          "genres": ["Action", "Sci-Fi"],                                 │
│          "poster_url": "/static/posters/19100159618-matrix.jpg"          │
│        },                                                                │
│        "metadata": {                                                     │
│          "created_at": null,                                             │
│          "updated_at": null,                                             │
│          "source": "enriched"                                            │
│        }                                                                 │
│      }                                                                   │
│    ],                                                                    │
│    "pagination": {                                                       │
│      "page": 1,                                                          │
│      "per_page": 50,                                                     │
│      "total": 150,                                                       │
│      "pages": 3                                                          │
│    }                                                                     │
│  }                                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Monitoring & Observability

```
Monitoring Dashboard
═══════════════════════════════════════════════════════════════════════════════

System Health Metrics
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   API Health    │  │   Data Fresh    │  │   Cache Hit     │            │
│  │   Status        │  │   Status        │  │   Rate          │            │
│  │                 │  │                 │  │                 │            │
│  │  ✅ Healthy     │  │  🟢 Fresh       │  │  📊 94.2%       │            │
│  │  Response: 45ms │  │  Last update:   │  │  Memory: 256MB  │            │
│  │                 │  │    2 min ago    │  │                 │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   External      │  │   Error Rate    │  │   Throughput    │            │
│  │   API Status    │  │                 │  │                 │            │
│  │                 │  │                 │  │                 │            │
│  │  🟢 TMDB: OK    │  │  📉 0.01%       │  │  🚀 1250 req/min│            │
│  │  🟢 IPTV: OK    │  │  Last 24h       │  │  Peak: 2100     │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```

Эта архитектурная диаграмма показывает полную картину того, как работает Cinema EPG Collector - от сбора данных IPTV до предоставления REST API с обогащенными метаданными из TMDB.
